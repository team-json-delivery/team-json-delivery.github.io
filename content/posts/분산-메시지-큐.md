# 분산 메시지 큐 설계해보기

MSA(Microservice Architecture)가 아키텍처 설계의 트랜드로 자리잡으면서 메시지 큐는 시스템 구성의 핵심요소가 되었습니다.    
이번 글에서는 가상 면접 사례로 배우는 대규모 시스템 설계 기초 2 4장 분산 메시지 큐를 소개하려고 합니다.


---

본격적인 설계에 앞서 메시지 큐의 기능을 생각해봅시다.

1. 프로듀서는 메시지 큐에 메시지를 보낼 수 있어야 합니다.
2. 컨슈머는 메시지 큐를 통해 메시지를 수신할 수 있어야 합니다.
3. 하나의 메시지를 서로 다른 컨슈머가 수신할 수 있다.
4. 메시지가 생산된 순서대로 소비될 수 있도록 순서를 보장해야 합니다.
5. 메시지는 최소 한 번, 최대 한 번, 정확히 한 번 가운데 설정할 수 있어야 합니다.

책에서는 그 외 몇 가지를 더 언급하고 있지만, 현업에서 메시지 큐를 사용할 때 위 5가지를 중점적으로 생각했던 것 같습니다.  

----

### 발행-구독 모델

다음으로 프로듀서에서 발행한 메시지가 컨슈머까지 어떻게 전달되는지 흐름을 생각해봅시다.  
책에서는 일대일 모델부터 단계적으로 소개하고 있지만, 이 글에서는 발행-구독 모델 기반의 최종 모습만 소개하겠습니다.  

![메시지큐-흐름.png](..%2F..%2Fstatic%2Fimages%2F%EB%B6%84%EC%82%B0-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90%2F%EB%A9%94%EC%8B%9C%EC%A7%80%ED%81%90-%ED%9D%90%EB%A6%84.png)

1. 주문 서비스(프로듀서)가 주문완료 이벤트 메시지를 발행합니다.
2. 메시지가 주문완료 토픽에 도착합니다.
3. 토픽에 도착한 메시지는 라운드 로빈 등의 방식으로 파티션에 분배됩니다.
4. 주문완료 토픽을 구독하고 있는 배송 컨슈머와 주문완료 알림톡 컨슈머는 수신 받은 메시지를 처리합니다.

### 토픽, 파티션

주문 서비스에서 발행한 주문완료 이벤트 메시지는 주문완료 토픽에 보관됩니다.  
토픽은 내부적으로 파티션으로 분할할 수 있는데, 라운드 로빈 등으로 메시지를 파티션에 분배합니다.  
파티션은 처리율과 연관있으며, 1개의 파티션에는 1개의 컨슈머만 할당할 수 있습니다.  
따라서 컨슈머가 아무리 많아도 파티션이 1개라면 처리율은 1입니다.  

파티션은 FIFO 큐처럼 동작하므로 같은 파티션 안에서는 메시지 순서를 보장할 수 있습니다.  
하지만 토픽 관점에서는 순서를 보장할 수 없기 때문에 A라는 주문번호에 대해 주문완료보다 주문취소가 먼저 처리되는 예상치 못 한 문제가 발생할 수 있습니다.  

토픽 관점에서 메시지 순서를 보장하기 위해서는 어떻게 해야할까요?  
메시지에 키를 할당하여 같은 키를 가진 메시지를 같은 파티션으로 보낸다면 토픽 관점에서도 순서를 보장할 수 있게 됩니다.  
단, 운영 중인 서비스에서 파티션을 조정하면 일시적으로 순서 보장이 안될 수 있으므로 주의해야 합니다.  

### 소비자 그룹



