# 분산 메시지 큐 설계해보기

MSA(Microservice Architecture)가 아키텍처 설계의 트랜드로 자리잡으면서 메시지 큐는 시스템 구성의 핵심요소가 되었습니다.    
이번 글에서는 가상 면접 사례로 배우는 대규모 시스템 설계 기초 2 4장 분산 메시지 큐를 소개하려고 합니다.  
메세지 큐를 구성하는 요소가 방대한 만큼 세부 개념에 대한 자세한 설명은 넘어가겠습니다.  

---

본격적인 설계에 앞서 메시지 큐의 기능을 생각해봅시다.

1. 프로듀서는 메시지 큐에 메시지를 보낼 수 있어야 합니다.
2. 컨슈머는 메시지 큐를 통해 메시지를 수신할 수 있어야 합니다.
3. 하나의 메시지를 서로 다른 컨슈머가 수신할 수 있어야 합니다.
4. 메시지가 생산된 순서대로 소비될 수 있도록 순서를 보장해야 합니다.
5. 오래된 이력 데이터는 삭제될 수 있습니다.
6. 메시지 크기는 킬로바이트 수준입니다.
7. 메시지는 최소 한 번, 최대 한 번, 정확히 한 번 가운데 설정할 수 있어야 합니다.

메시지 큐의 비기능 요구사항은 3가지가 있습니다.

1. 높은 대역폭과 낮은 전송 지연 중 하나를 설정으로 선택 가능해야 합니다.
2. 메시지 양이 급증해도 처리 가능해야 합니다.
3. 데이터는 디스크에 보관되어야 하며 여러 노드에 복제되어야 합니다.

> Kafka와 RabbitMQ의 차이점은 무엇인가요?  
> https://aws.amazon.com/ko/compare/the-difference-between-rabbitmq-and-kafka/

----

다음으로 프로듀서에서 발행한 메시지가 컨슈머까지 어떻게 전달되는지 흐름을 생각해봅시다.  
책에서는 일대일 모델부터 단계적으로 소개하고 있지만, 이 글에서는 발행-구독 모델 기반의 최종 모습만 소개하겠습니다.  

![메시지큐-흐름.png](..%2F..%2Fstatic%2Fimages%2F%EB%B6%84%EC%82%B0-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90%2F%EB%A9%94%EC%8B%9C%EC%A7%80%ED%81%90-%ED%9D%90%EB%A6%84.png)

1. 주문 서비스(프로듀서)가 주문완료 이벤트 메시지를 발행합니다.
2. 메시지가 주문완료 토픽에 도착합니다.
3. 토픽에 도착한 메시지는 라운드 로빈 등의 방식으로 파티션에 분배됩니다.
4. 주문완료 토픽을 구독하고 있는 배송 컨슈머와 주문완료 알림톡 컨슈머는 수신 받은 메시지를 처리합니다.

위 이미지와 같이 프로듀서가 토픽에 메시지를 발행하고, 컨슈머 그룹이 토픽(파티션)의 메시지를 구독한다면 요구사항 1~3번을 달성할 수 있습니다.  

> Kafka에서 파티션 증가 없이 동시 처리량을 늘리는 방법 - Parallel Consumer  
> https://d2.naver.com/helloworld/7181840

----

메시지의 순서는 어떻게 보장할 수 있을까요?  

파티션은 FIFO 큐처럼 동작하므로 같은 파티션 안에서는 메시지 순서를 보장할 수 있습니다.  
하지만 토픽 관점에서는 순서를 보장할 수 없기 때문에 메시지에 키를 할당해야 합니다.

![메시지큐-메시지키.png](..%2F..%2Fstatic%2Fimages%2F%EB%B6%84%EC%82%B0-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90%2F%EB%A9%94%EC%8B%9C%EC%A7%80%ED%81%90-%EB%A9%94%EC%8B%9C%EC%A7%80%ED%82%A4.png)

위 이미지처럼 같은 키를 가진 메시지를 같은 파티션으로 보낸다면 키를 가진 메시지는 순서를 보장할 수 있게 됩니다.  
(물론, 메시지 키를 할당하여도 토픽 관점에서 완벽한 순서 보장은 어렵습니다.)

----

데이터의 장기 보관 요구사항을 만족하면서 높은 대역폭을 제공하려면 데이터 저장소와 적재 방식을 고민해야 합니다.  

메시지 큐는 읽기와 쓰기가 대규모로 빈번하게 일어나기 때문에 파일에 저장하는 것이 적합합니다.  
책에서는 쓰기 우선 로그(Write-Ahead Log, WAL)을 소개하고 있는데, 새로운 항목이 추가되기만 하는 일반적인 파일 구조입니다.  
또한, 파일이 무한정 커질 것을 대비하여 세그먼트 단위로 파일을 분할해야 합니다.  

![메시지큐-저장방식.png](..%2F..%2Fstatic%2Fimages%2F%EB%B6%84%EC%82%B0-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90%2F%EB%A9%94%EC%8B%9C%EC%A7%80%ED%81%90-%EC%A0%80%EC%9E%A5%EB%B0%A9%EC%8B%9D.png)

위와 같이 토픽의 파티션 하위에 세그먼트별로 WAL을 관리한다면, 용량 한계에 도달하거나 보관 기간이 만료된 오래된 세그먼트 파일을 삭제할 수 있습니다.  

책에서는 회전 디스크 사용과 배치 처리 등 I/O를 줄이는 방법도 소개하고 있습니다.  

----
